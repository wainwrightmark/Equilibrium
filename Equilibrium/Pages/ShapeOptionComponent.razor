@using Excubo.Blazor.Canvas.Contexts
@using tainicom.Aether.Physics2D.Common

<button @onclick="OnClick">
    <Canvas
        @ref="_canvas"
        Width="@Width"
        Height="@Height">
    </Canvas>
</button>

<label>@Count</label>
<button @onclick="Rotate" disabled="@(GameShape.RotationInterval is null)">↻</button>

@code {

    private Canvas _canvas = null!;
    private Context2D _canvasContext= null!;

    [Parameter]
    public GameShape GameShape { get; set; } = null!;

    [Parameter]
    public int Count { get; set; }


    [Parameter]
    public TransientState TransientState { get; set; } = null!;

    public int NumberOfRotations { get; private set; } = 0;

    private ChosenShape ThisAsChosenShape => new(GameShape, NumberOfRotations);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _canvasContext = await _canvas.GetContext2DAsync();
        }
        await Draw();
    }

        public const float Width = 100;
        public const float Height = 100;

    public async Task Rotate()
    {
        NumberOfRotations++;

        if (TransientState.ChosenShape?.Shape == GameShape)
        {
            TransientState.ChosenShape = ThisAsChosenShape;
        }
        await Draw();
    }

    public async Task Draw()
    {
        string color;
        if (Count <= 0)
        {
            color = "grey";
        }
        else if (TransientState.ChosenShape?.Shape == GameShape)
        {
            color = "green";
        }
        else
        {
            color = "yellow";
        }

        await using var batch = _canvasContext.CreateBatch();

        await batch.ClearRectAsync(0, 0, Width, Height);

        await batch.LineWidthAsync(1);

        await batch.FillStyleAsync(color);
        await batch.StrokeStyleAsync("black");

        var rotation = ThisAsChosenShape.Rotation;
        foreach (var shape in GameShape.GetShapes(60))
        {
            await batch.DrawShapeAsync(
                shape,
                new Transform(new Vector2(Width / 2, Height / 2), rotation));
        }
    }

    private async Task OnClick()
    {
        if (Count > 0)
        {
            if (TransientState.ChosenShape?.Shape == GameShape)
            {
                TransientState.ChosenShape = null;
            }
                
            else
                TransientState.ChosenShape = ThisAsChosenShape;

            await Draw();
        }
        
    }

}