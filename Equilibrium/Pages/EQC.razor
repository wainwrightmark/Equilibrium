@using tainicom.Aether.Physics2D.Dynamics
@using tainicom.Aether.Physics2D.Common

<div style="width: 100%">
    <div id="canvasContainer"
         @ref="container"
         style="margin-left: auto; margin-right: auto; width: @(CanvasWidth + "px"); height: @(CanvasHeight + "px"); position: relative; border: 1px solid black;">
        <Canvas @onmousemove="MouseMoveCanvas"
                @onmouseup="MouseUpCanvas"
                @onmousedown="MouseDownCanvas"
                @onmouseout="MouseOutCanvas"

                @ontouchleave="TouchLeaveCanvas"
                @ontouchmove="TouchMoveCanvas"

                @ontouchend="TouchEndCanvas"

                @ref="_canvas"
                Width="@CanvasWidth"
                Height="@CanvasHeight">
        </Canvas>

        <div style="position: absolute; top: 50px; left: 50px;">

            <label>FPS: @TransientState.FramesPerSecond</label>
            <br/>
            <button @onclick="() => GameState.Restart(TransientState)">Restart</button>
            <br/>

            @if (GameState.IsWin is not null)
            {
@if (GameState.Message is not null)
{
    <label>@GameState.Message</label>
    <br/>
}

                <label>Difficulty</label>
                <RatingComponent @bind-Rating="LevelDifficulty"/>
                <br/>
                <label>Fun</label>
                <RatingComponent @bind-Rating="LevelFun"/>
                <br/>
                <button @onclick="ChangeLevel">ChangeLevel</button>
            }
        </div>


    </div>
</div>


<div style="width: @(CanvasWidth + "px"); height: 135px; overflow-y: hidden; overflow-x: auto; margin-left: auto; margin-right: auto;">
    <menu style="display: flex; list-style: none; padding: 0; margin-top: 5px;">
        @foreach (var shape in GameState.RemainingShapes())
        {
            <div style="margin: 0; padding: 0;">
                <ShapeOptionComponent GameShape="shape.shape" Count="@shape.count" TransientState="TransientState"/>
            </div>
        }
    </menu>

</div>


@code{

        public const float CanvasWidth = 350;
        public const float CanvasHeight = 500;


    public UserLevel UserLevel { get; set; } = new("Basic", Level.Basic, false, null, null);

    public async Task ChangeLevel()
    {
        var seed = new Random().Next();

        var name = $"Level-{seed}";
        var level = Level.MakeRandomLevel(new Random(seed));
        UserLevel = new UserLevel(name, level, false, null, null);


        GameState.ChangeLevel(level, TransientState);

    //await SaveLevel();
    }

    private Task SaveLevel()
    {
        return LocalStorageService.SetItemAsync(UserLevel.Name, UserLevel);
    }

    public int? LevelDifficulty
    {
        get => UserLevel.DifficultyStars;
        set
        {
            UserLevel = UserLevel with{DifficultyStars = value};
            SaveLevel();
        }
    }

    public int? LevelFun
    {
        get => UserLevel.FunStars;
        set
        {
            UserLevel = UserLevel with{FunStars = value};
            SaveLevel();
        }
    }


}